<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="ClinicaApp.Views.CreateAppointmentPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:sys="clr-namespace:System;assembly=netstandard"
             xmlns:viewmodels="clr-namespace:ClinicaApp.ViewModels"
             xmlns:models="clr-namespace:ClinicaApp.Models"
             x:DataType="viewmodels:CreateAppointmentViewModel"
             Title="Agendar Cita">

    <ScrollView Padding="20">
        <StackLayout Spacing="20">

            <Label Text="ðŸ“… Agendar Nueva Cita" 
                   FontSize="24" 
                   FontAttributes="Bold" 
                   TextColor="#4CAF50" 
                   HorizontalOptions="Center" />

            <!-- Tipo de Cita -->
            <Frame BackgroundColor="White" HasShadow="True" CornerRadius="15" Padding="20">
                <StackLayout Spacing="15">
                    <Label Text="1. Tipo de Cita" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#4CAF50" />

                    <Picker ItemsSource="{Binding TiposCita}" 
                            SelectedItem="{Binding TipoCitaSeleccionada}" 
                            Title="Seleccione tipo de cita"
                            BackgroundColor="#F5F5F5" />
                </StackLayout>
            </Frame>

            <!-- Especialidad y Sucursal -->
            <Frame BackgroundColor="White" HasShadow="True" CornerRadius="15" Padding="20">
                <StackLayout Spacing="15">
                    <Label Text="2. Especialidad y Sucursal" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#4CAF50" />

                    <Label Text="Especialidad *" TextColor="#666" FontSize="14" />
                    <Picker ItemsSource="{Binding Especialidades}" 
                            ItemDisplayBinding="{Binding NombreEspecialidad}"
                            SelectedItem="{Binding EspecialidadSeleccionada}" 
                            Title="Seleccione especialidad"
                            BackgroundColor="#F5F5F5" />

                    <Label Text="Sucursal *" TextColor="#666" FontSize="14" />
                    <Picker ItemsSource="{Binding Sucursales}" 
                            ItemDisplayBinding="{Binding NombreSucursal}"
                            SelectedItem="{Binding SucursalSeleccionada}" 
                            Title="Seleccione sucursal"
                            BackgroundColor="#F5F5F5" />

                    <Button Text="BUSCAR MÃ‰DICOS" 
                            Command="{Binding LoadMedicosCommand}"
                            BackgroundColor="#2196F3" 
                            TextColor="White" />
                </StackLayout>
            </Frame>

            <!-- MÃ©dicos Disponibles -->
            <Frame BackgroundColor="White" 
       HasShadow="True" 
       CornerRadius="15" 
       Padding="20"
       IsVisible="{Binding ShowMedicos}">

                <StackLayout Spacing="15">
                    <Label Text="3. Seleccionar MÃ©dico" 
               FontSize="18" 
               FontAttributes="Bold" 
               TextColor="#4CAF50" />

                    <StackLayout BindableLayout.ItemsSource="{Binding Medicos}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:MedicoPorEspecialidad">
                                <Border BackgroundColor="White" 
                            Stroke="#E0E0E0" 
                            StrokeThickness="1"
                            Margin="0,5">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="8" />
                                    </Border.StrokeShape>

                                    <StackLayout Padding="15">
                                        <Label Text="{Binding NombreCompleto}" 
                                   FontAttributes="Bold" 
                                   FontSize="16" />
                                        <Label Text="{Binding Especialidad}" 
                                   FontSize="12" 
                                   TextColor="Gray" />
                                        <Label Text="{Binding Sucursal}" 
                                   FontSize="12" 
                                   TextColor="Gray" />
                                    </StackLayout>

                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectMedicoCommand}"
                                                  CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </StackLayout>

                    <!-- Mostrar mÃ©dico seleccionado -->
                    <Label Text="{Binding MedicoSeleccionado.NombreCompleto, StringFormat='MÃ©dico seleccionado: {0}'}" 
               FontSize="14" 
               FontAttributes="Bold" 
               TextColor="#4CAF50" 
               IsVisible="{Binding MedicoSeleccionado, Converter={StaticResource NullToBoolConverter}}" />
                </StackLayout>
            </Frame>

            <!-- Fecha y Horarios -->
            <Frame BackgroundColor="White" 
                   HasShadow="True" 
                   CornerRadius="15" 
                   Padding="20"
                   IsVisible="{Binding MedicoSeleccionado, Converter={StaticResource NullToBoolConverter}}">

                <StackLayout Spacing="15">
                    <Label Text="4. Fecha y Hora" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#4CAF50" />

                    <Label Text="Fecha *" TextColor="#666" FontSize="14" />
                    <DatePicker Date="{Binding FechaSeleccionada}"
                        MinimumDate="{x:Static sys:DateTime.Today}"
                        BackgroundColor="#F5F5F5" />

                    <Button Text="BUSCAR HORARIOS DISPONIBLES" 
                            Command="{Binding LoadHorariosCommand}"
                            BackgroundColor="#FF9800" 
                            TextColor="White" />
                </StackLayout>
            </Frame>

            <!-- Horarios Disponibles -->
            <Frame BackgroundColor="White" 
       HasShadow="True" 
       CornerRadius="15" 
       Padding="20"
       IsVisible="{Binding ShowHorarios}">

                <StackLayout Spacing="15">
                    <Label Text="Horarios Disponibles" 
               FontSize="16" 
               FontAttributes="Bold" 
               TextColor="#4CAF50" />

                    <StackLayout BindableLayout.ItemsSource="{Binding HorariosDisponibles}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:HorarioDisponible">
                                <Border BackgroundColor="#E8F5E8" 
                            Stroke="#4CAF50" 
                            StrokeThickness="1"
                            Margin="0,5">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="8" />
                                    </Border.StrokeShape>

                                    <Grid Padding="15" ColumnDefinitions="*,*,Auto">
                                        <Label Grid.Column="0" 
                                   Text="{Binding Hora}" 
                                   FontAttributes="Bold" 
                                   VerticalOptions="Center" />
                                        <Label Grid.Column="1" 
                                   Text="{Binding HoraFin}" 
                                   FontSize="12" 
                                   TextColor="Gray" 
                                   VerticalOptions="Center" />
                                        <Label Grid.Column="2" 
                                   Text="45 min" 
                                   FontSize="10" 
                                   TextColor="Gray" 
                                   VerticalOptions="Center" />
                                    </Grid>

                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectHorarioCommand}"
                                                  CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </StackLayout>

                    <!-- Mostrar horario seleccionado -->
                    <Label Text="{Binding HorarioSeleccionado.Hora, StringFormat='Horario seleccionado: {0}'}" 
               FontSize="14" 
               FontAttributes="Bold" 
               TextColor="#4CAF50" 
               IsVisible="{Binding HorarioSeleccionado, Converter={StaticResource NullToBoolConverter}}" />
                </StackLayout>
            </Frame>

            <!-- InformaciÃ³n del Paciente -->
            <Frame BackgroundColor="White" HasShadow="True" CornerRadius="15" Padding="20">
                <StackLayout Spacing="15">
                    <Label Text="5. InformaciÃ³n del Paciente" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#4CAF50" />

                    <Label Text="CÃ©dula del Paciente *" TextColor="#666" FontSize="14" />
                    <Entry Text="{Binding CedulaPaciente}" 
                           Placeholder="1234567890" 
                           Keyboard="Numeric" 
                           MaxLength="10"
                           BackgroundColor="#F5F5F5" />

                    <Button Text="BUSCAR PACIENTE" 
                            Command="{Binding SearchPatientCommand}"
                            BackgroundColor="#9C27B0" 
                            TextColor="White" />

                    <!-- Info del paciente encontrado -->
                    <Frame BackgroundColor="#E8F5E8" 
                           BorderColor="#4CAF50" 
                           CornerRadius="8" 
                           Padding="15"
                           IsVisible="{Binding ShowPacienteInfo}">
                        <StackLayout>
                            <Label Text="Paciente Encontrado:" 
                                   FontAttributes="Bold" 
                                   TextColor="#4CAF50" />
                            <Label Text="{Binding PacienteInfo}" 
                                   FontSize="14" />
                        </StackLayout>
                    </Frame>

                    <!-- BotÃ³n crear paciente -->
                    <Button Text="CREAR NUEVO PACIENTE" 
                            Command="{Binding CreatePatientCommand}"
                            BackgroundColor="Transparent" 
                            TextColor="#F44336" 
                            BorderColor="#F44336" 
                            BorderWidth="1"
                            IsVisible="{Binding ShowCreatePatientButton}" />
                </StackLayout>
            </Frame>

            <!-- Detalles de la Cita -->
            <Frame BackgroundColor="White" 
                   HasShadow="True" 
                   CornerRadius="15" 
                   Padding="20"
                   IsVisible="{Binding PacienteEncontrado, Converter={StaticResource NullToBoolConverter}}">

                <StackLayout Spacing="15">
                    <Label Text="6. Detalles de la Cita" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#4CAF50" />

                    <Label Text="Motivo de la Consulta *" TextColor="#666" FontSize="14" />
                    <Entry Text="{Binding MotivoConsulta}" 
                           Placeholder="Describe el motivo de la consulta" 
                           BackgroundColor="#F5F5F5" />

                    <Label Text="Observaciones" TextColor="#666" FontSize="14" />
                    <Editor Text="{Binding Observaciones}" 
                            Placeholder="Observaciones adicionales (opcional)" 
                            HeightRequest="100"
                            BackgroundColor="#F5F5F5" />

                    <!-- BotÃ³n crear cita -->
                    <Button Text="CREAR CITA" 
                            Command="{Binding CreateAppointmentCommand}"
                            BackgroundColor="#4CAF50" 
                            TextColor="White" 
                            FontAttributes="Bold" 
                            HeightRequest="50"
                            IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}" />

                    <!-- Loading -->
                    <StackLayout IsVisible="{Binding IsLoading}" 
                                 HorizontalOptions="Center" 
                                 Orientation="Horizontal" 
                                 Spacing="10">
                        <ActivityIndicator IsRunning="{Binding IsLoading}" Color="#4CAF50" />
                        <Label Text="Creando cita..." TextColor="Gray" />
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- Mensaje -->
            <Label Text="{Binding Message}" 
                   TextColor="{Binding IsSuccess, Converter={StaticResource BoolToColorConverter}}"
                   FontSize="14" 
                   IsVisible="{Binding Message, Converter={StaticResource StringNotNullOrEmptyConverter}}"
                   HorizontalOptions="Center" 
                   HorizontalTextAlignment="Center" />

        </StackLayout>
    </ScrollView>
</ContentPage>