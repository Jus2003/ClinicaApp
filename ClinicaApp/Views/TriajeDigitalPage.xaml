<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:helpers="clr-namespace:ClinicaApp.Helpers"
             x:Class="ClinicaApp.Views.TriajeDigitalPage"
             Title="Triaje Digital">

    <Grid>
        <!-- Loading Overlay -->
        <Grid IsVisible="{Binding IsLoading}" 
              BackgroundColor="#80000000" 
              ZIndex="999">
            <StackLayout VerticalOptions="Center" HorizontalOptions="Center">
                <ActivityIndicator IsRunning="True" Color="White" Scale="1.5"/>
                <Label Text="Cargando..." TextColor="White" FontSize="16"/>
            </StackLayout>
        </Grid>

        <!-- Main Content con ScrollView -->
        <ScrollView>
            <StackLayout Padding="15" Spacing="15">

                <!-- Header -->
                <Frame BackgroundColor="White" CornerRadius="10" Padding="15" HasShadow="True">
                    <Label Text="Triaje Digital" 
                           FontSize="20" 
                           FontAttributes="Bold" 
                           TextColor="#2E7D32" 
                           HorizontalTextAlignment="Center"/>
                </Frame>

                <!-- Debug y botÃ³n refresh -->
                <StackLayout Orientation="Horizontal" HorizontalOptions="FillAndExpand">
                    <Label Text="{Binding Citas.Count, StringFormat='Citas: {0}'}" 
                           FontSize="14" 
                           TextColor="Blue"
                           VerticalOptions="Center"/>
                    <Button Text="Actualizar" 
                            Command="{Binding RefreshCommand}"
                            HorizontalOptions="EndAndExpand"
                            WidthRequest="100"
                            HeightRequest="40"/>
                </StackLayout>

                <!-- Message -->
                <Label Text="{Binding Message}" 
                       TextColor="Red" 
                       IsVisible="{Binding Message, Converter={StaticResource StringToBoolConverter}}"
                       HorizontalTextAlignment="Center"/>

                <!-- Lista de Citas -->
                <StackLayout BindableLayout.ItemsSource="{Binding Citas}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="White" 
                                   CornerRadius="8" 
                                   Margin="0,5" 
                                   Padding="0"
                                   HasShadow="True">

                                <Grid>
                                    <!-- TAP GESTURE -->
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.CitaSelectedCommand}" 
                                                             CommandParameter="{Binding}"/>
                                    </Grid.GestureRecognizers>

                                    <StackLayout Padding="15" Spacing="8">
                                        <!-- Header de la cita -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <Label Grid.Column="0"
                                                   Text="{Binding NombreEspecialidad}" 
                                                   FontSize="16" 
                                                   FontAttributes="Bold" 
                                                   TextColor="#1565C0"/>

                                            <Label Grid.Column="1"
                                                   Text="{Binding EstadoCita}" 
                                                   FontSize="12" 
                                                   TextColor="White"
                                                   BackgroundColor="#4CAF50"
                                                   Padding="8,4"
                                                   HorizontalTextAlignment="Center"/>
                                        </Grid>

                                        <!-- InformaciÃ³n de la cita -->
                                        <Label Text="{Binding NombreMedico}" 
                                               FontSize="14" 
                                               TextColor="#333"/>

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <Label Grid.Column="0"
                                                   Text="{Binding FechaFormateada}" 
                                                   FontSize="12" 
                                                   TextColor="#666"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding HoraFormateada}" 
                                                   FontSize="12" 
                                                   TextColor="#666"
                                                   HorizontalTextAlignment="End"/>
                                        </Grid>

                                        <Label Text="Toque para gestionar triaje" 
                                               FontSize="11" 
                                               TextColor="#999" 
                                               FontAttributes="Italic"
                                               HorizontalTextAlignment="Center"/>
                                    </StackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <!-- Empty State -->
                <StackLayout IsVisible="{Binding HasCitas, Converter={StaticResource InvertedBoolConverter}}" 
                            Spacing="15" 
                            Margin="0,50,0,0">
                    <Label Text="ðŸ“…" 
                           FontSize="48" 
                           HorizontalTextAlignment="Center"/>
                    <Label Text="No hay citas disponibles" 
                           FontSize="16" 
                           FontAttributes="Bold" 
                           HorizontalTextAlignment="Center"/>
                </StackLayout>

                <!-- Espaciado final -->
                <BoxView HeightRequest="50" Color="Transparent"/>

            </StackLayout>
        </ScrollView>
    </Grid>
</ContentPage>